@page
@model dynamic
@{
    ViewData["Title"] = "Quản lý giải chạy";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body {
        background: #f8fafc;
        font-family: 'Inter', sans-serif;
    }

    .container {
        max-width: 1000px;
        margin-top: 50px;
    }

    h2 {
        color: #3b5bdb;
        font-weight: 700;
        margin-bottom: 25px;
    }

    .btn-primary {
        background: #3b5bdb;
        border: none;
    }

        .btn-primary:hover {
            background: #364fc7;
        }

    .btn-danger {
        background: #e03131;
        border: none;
    }

    .table {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
</style>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>🏁 Quản lý giải chạy</h2>
        <button class="btn btn-primary" onclick="showAddForm()">➕ Thêm giải</button>
    </div>

    <table class="table table-hover text-center align-middle">
        <thead class="table-primary">
            <tr>
                <th>ID</th>
                <th>Tên giải</th>
                <th>Ngày bắt đầu</th>
                <th>Ngày kết thúc</th>
                <th>Mô tả</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody id="raceList">
            <tr><td colspan="6">⏳ Đang tải dữ liệu...</td></tr>
        </tbody>
    </table>
</div>

<script>
    const apiUrl = "http://localhost:5288/api/admin/RaceManagement";
    const token = localStorage.getItem("token");
    if (!token) window.location.href = "/Auth/Login";

    async function loadRaces() {
        const tbody = document.getElementById("raceList");
        try {
            const res = await fetch(apiUrl, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            if (!res.ok) throw new Error("Không thể tải danh sách giải chạy!");
            const data = await res.json();
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6">Chưa có giải chạy nào.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(r => `
                <tr>
                    <td>${r.raceId}</td>
                    <td>${r.raceName}</td>
                    <td>${new Date(r.startDate).toLocaleDateString()}</td>
                    <td>${new Date(r.endDate).toLocaleDateString()}</td>
                    <td>${r.description || "—"}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteRace(${r.raceId}, '${r.raceName}')">🗑️ Xóa</button>
                    </td>
                </tr>
            `).join("");
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-danger">${err.message}</td></tr>`;
        }
    }

    async function deleteRace(id, name) {
        Swal.fire({
            title: `Xóa giải "${name}"?`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Xóa",
            cancelButtonText: "Hủy",
            confirmButtonColor: "#e03131"
        }).then(async result => {
            if (!result.isConfirmed) return;
            const res = await fetch(`${apiUrl}/${id}`, {
                method: "DELETE",
                headers: { "Authorization": `Bearer ${token}` }
            });
            if (res.ok) {
                Swal.fire("Đã xóa!", "", "success");
                loadRaces();
            } else {
                Swal.fire("Lỗi!", "Không thể xóa giải này.", "error");
            }
        });
    }

    function showAddForm() {
        Swal.fire({
            title: "Thêm giải chạy mới",
            html: `
                <input id="rname" class="swal2-input" placeholder="Tên giải">
                <input id="rstart" type="date" class="swal2-input" placeholder="Ngày bắt đầu">
                <input id="rend" type="date" class="swal2-input" placeholder="Ngày kết thúc">
                <textarea id="rdesc" class="swal2-textarea" placeholder="Mô tả"></textarea>
            `,
            confirmButtonText: "Lưu",
            showCancelButton: true,
            preConfirm: async () => {
                const raceName = document.getElementById("rname").value.trim();
                const startDate = document.getElementById("rstart").value;
                const endDate = document.getElementById("rend").value;
                const description = document.getElementById("rdesc").value.trim();
                if (!raceName) return Swal.showValidationMessage("Vui lòng nhập tên giải!");

                const res = await fetch(apiUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
                    body: JSON.stringify({ raceName, startDate, endDate, description })
                });
                if (!res.ok) throw new Error("Không thể tạo giải chạy!");
            }
        }).then(result => {
            if (result.isConfirmed) {
                Swal.fire("✅ Thành công!", "Đã thêm giải chạy.", "success");
                loadRaces();
            }
        });
    }

    loadRaces();
</script>
