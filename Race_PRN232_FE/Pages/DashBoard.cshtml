@page
@model dynamic
@{
    ViewData["Title"] = "Bảng điều khiển | RacePRN232";
}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(180deg, #f8faff 0%, #eef2fb 100%);
        min-height: 100vh;
    }

    /* === NAVBAR === */
    nav.navbar {
        background-color: #ffffff;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
    }

    .navbar-brand {
        font-weight: 700;
        color: #4c6ef5 !important;
    }

    .nav-link {
        font-weight: 500;
        color: #333 !important;
    }

        .nav-link:hover {
            color: #4c6ef5 !important;
        }

    /* === HEADER === */
    .header-bar {
        background: linear-gradient(90deg, #4c6ef5, #5f8efb);
        border-radius: 12px;
        color: white;
        padding: 1.2rem 1.6rem;
        margin-top: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

        .header-bar h3 {
            margin: 0;
            font-weight: 600;
        }

    /* === RACE CARD === */
    .race-card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
        background: #fff;
        overflow: hidden;
        transition: 0.3s ease;
    }

        .race-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 22px rgba(0, 0, 0, 0.1);
        }

    .race-image {
        width: 100%;
        height: 180px;
        object-fit: cover;
    }

    .race-info {
        padding: 1.2rem 1.4rem;
    }

        .race-info h5 {
            color: #4c6ef5;
            font-weight: 700;
        }

        .race-info p {
            margin-bottom: 0.3rem;
        }

    .empty-text {
        color: #6c757d;
        font-size: 0.95rem;
        text-align: center;
        margin-top: 1rem;
    }
</style>

<!-- ✅ NAVBAR -->
<nav class="navbar navbar-expand-lg fixed-top">
    <div class="container-fluid px-4">
        <a class="navbar-brand" href="/Dashboard">🏁 Race_PRN232_FE</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="/Privacy">Privacy</a></li>
                <!-- 🔹 Chỉ hiện khi là Admin -->
                <li class="nav-item d-none" id="navRace">
                    <a class="nav-link text-primary fw-semibold" href="/Manager/RaceManagement">🏁 Quản lý giải chạy</a>
                </li>
                <li class="nav-item d-none" id="navUsers">
                    <a class="nav-link text-success fw-semibold" href="/Manager/UsersManagement">👤 Quản lý người dùng</a>
                </li>
            </ul>
            <button class="btn btn-outline-danger btn-sm" id="logoutBtn">🚪 Đăng xuất</button>
        </div>
    </div>
</nav>

<div class="container" style="padding-top: 90px;">
    <div class="header-bar d-flex justify-content-between align-items-center">
        <h3>Xin chào, <span id="username"></span>!</h3>
    </div>

    <h4 class="mb-3 text-center text-primary fw-bold">Danh sách giải chạy đang mở</h4>

    <div id="raceList" class="row g-4 justify-content-center">
        <div class="text-center text-secondary mt-4">⏳ Đang tải dữ liệu...</div>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    const apiUrl = "http://localhost:5288/api/Race";

    if (!token) window.location.href = "/Auth/Login";

    document.getElementById("username").textContent = user.fullName || "Người dùng";

    // ✅ Nếu là Admin thì hiển thị 2 link quản lý
    const role = (user.roleName || "").toLowerCase();
    if (role === "admin") {
        document.getElementById("navRace").classList.remove("d-none");
        document.getElementById("navUsers").classList.remove("d-none");
    }

    // ✅ Logout
    document.getElementById("logoutBtn").addEventListener("click", () => {
        Swal.fire({
            title: "Xác nhận đăng xuất?",
            text: "Bạn có chắc muốn đăng xuất khỏi hệ thống?",
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "Đăng xuất",
            cancelButtonText: "Hủy",
            confirmButtonColor: "#dc3545"
        }).then(result => {
            if (result.isConfirmed) {
                localStorage.clear();
                window.location.href = "/Auth/Login";
            }
        });
    });

    // ✅ Load danh sách giải chạy
    const raceContainer = document.getElementById("raceList");

    async function loadRaces() {
        try {
            const res = await fetch(apiUrl, {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!res.ok) throw new Error("Không thể tải danh sách giải chạy.");

            const data = await res.json();

            if (!data || data.length === 0) {
                raceContainer.innerHTML = `<p class="empty-text">Hiện chưa có giải chạy nào được tổ chức.</p>`;
                return;
            }

            raceContainer.innerHTML = data.map(race => `
                <div class="col-md-6 col-lg-4">
                    <div class="race-card">
                        <img src="${race.imageUrl || 'https://images.unsplash.com/photo-1508609349937-5ec4ae374ebf'}" class="race-image" alt="Race Image">
                        <div class="race-info">
                            <h5>${race.raceName}</h5>
                            <p>📍 <b>Địa điểm:</b> ${race.locationName || "Chưa có"}</p>
                            <p>📅 <b>Ngày diễn ra:</b> ${formatDate(race.startDate)}${race.endDate ? ` - ${formatDate(race.endDate)}` : ""}</p>
                            <p class="text-muted">${race.description || "Không có mô tả"}</p>
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm me-1" onclick="viewRace(${race.raceId})">👁️ Xem chi tiết</button>
                                <button class="btn btn-success btn-sm" onclick="registerRace(${race.raceId})">🏃 Tham gia</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join("");

        } catch (err) {
            raceContainer.innerHTML = `<p class="text-danger text-center">❌ ${err.message}</p>`;
        }
    }

    loadRaces();

    function formatDate(dateStr) {
        if (!dateStr) return "";
        const date = new Date(dateStr);
        return date.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit", year: "numeric" });
    }

    function viewRace(id) {
        window.location.href = `/Races/Details?raceId=${id}`;
    }

    async function registerRace(id) {
        Swal.fire({
            title: "Tham gia giải chạy?",
            text: "Chọn vai trò khi tham gia:",
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "🏃 Runner",
            cancelButtonText: "🤝 Supporter",
            confirmButtonColor: "#198754",
            cancelButtonColor: "#0d6efd"
        }).then(async (result) => {
            if (!result.isConfirmed && !result.dismiss) return;

            const roleInRace = result.isConfirmed ? "Runner" : "Supporter";

            try {
                const res = await fetch(`${apiUrl}/register/${id}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ roleInRace })
                });

                if (res.ok) {
                    Swal.fire({
                        icon: "success",
                        title: "🎉 Đăng ký thành công!",
                        text: `Bạn đã tham gia với vai trò ${roleInRace}.`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    const err = await res.json().catch(() => ({}));
                    Swal.fire({
                        icon: "error",
                        title: "Không thể đăng ký!",
                        text: err.message || "Vui lòng thử lại.",
                        confirmButtonColor: "#d33"
                    });
                }
            } catch (err) {
                Swal.fire({
                    icon: "error",
                    title: "Lỗi kết nối!",
                    text: "Không thể kết nối tới máy chủ.",
                    confirmButtonColor: "#d33"
                });
            }
        });
    }
</script>
